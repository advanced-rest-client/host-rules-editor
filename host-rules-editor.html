<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../openable-panel-behavior/openable-panel-behavior.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../tutorial-toast/tutorial-toast.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../uuid-generator/uuid-generator.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="host-rules-editor-item.html">
<link rel="import" href="host-rules-tester.html">
<!--
An element to render host rules mapping editor.

Host rules mapping allow ARC to redirect connection from one URI to another
without changinh the `host` header value. This element allows to enter mapping
rules and to test them agains arbitrary URL.

NOTE: This element does not provide data storing interface. Instead of operating
on a data store it sends custom events that should be handled by the hosting
application. Example inferface is included in `arc-models/host-rules-model` element.

NOTE: This element works with `arc-data-export` element to export data to a file.
You can use other way to handle `export-user-data` custom event to export host
rules data.

### Example
```
<arc-data-export></arc-data-export>
<host-rules-model></host-rules-model>
<host-rules-editor></host-rules-editor>
```

### Data model

The `items` property accepts an array of the following objects:

``` javascript
{
  from: String, // The from rule (may contain asterisks)
  to: String, // replacement value
  enabled: Boolean, // if false the rule is ignored
  comment: String // optional rule description
}
```

### Narrow view

The element does not recognizes screen size to render mobile like view. To render
narrow view (that fit mobile screen or narrow drawer etc) set `narrow` attribute
on the element

```html
<host-rules-editor narrow></host-rules-editor>
```

### Styling
`<host-rules-editor>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--host-rules-editor` | Mixin applied to the element | `{}`
`--inline-fom-action-icon-color` | Color of the icons in the form editor | `rgba(0, 0, 0, 0.74)`
`--inline-fom-action-icon-color-hover` | Color of the icons in the form editor when hovering | `--accent-color` or `rgba(0, 0, 0, 0.74)`
`--host-rules-editor-loader` | Mixin applied to the paper-progress element when loading rules | `{}`
`--host-rules-editor-empty-screen` | Mixin applied to the empty screen message | `{}`
`--host-rules-editor-item-input` | Mixin applied to the rules inputs | `{}`
`--host-rules-editor-item-comment-input` | Mixin applied to the comment textarea input | `{}`
`--host-rules-editor-item-comment-input-narrow` | Mixin applied to the comment textarea input in narrow view | `{}`
`--host-rules-editor-tutorial-toast` | Mixin applied to the tutorial toast element | `{}`

@group UI Elements
@element host-rules-editor
@demo demo/index.html
-->
<dom-module id="host-rules-editor">
  <template>
    <style>
    :host {
      display: block;
      @apply --host-rules-editor;
    }

    .header {
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    h2 {
      margin-left: 16px;
      @apply --arc-font-headline;
      @apply --layout-flex;
    }

    h3 {
      margin-left: 16px;
      @apply --arc-font-subhead;
    }

    [hidden] {
      display: none !important;
    }

    paper-progress {
      width: 100%;
      @apply --host-rules-editor-loader;
    }

    #dataClearDialog {
      background-color: var(--warning-primary-color, #FF7043);
      color: var(--warning-contrast-color, #fff);
    }

    #dataClearDialog paper-button {
      color: #fff;
      background-color: transparent;
    }

    .error-toast {
      background-color: var(--warning-primary-color, #FF7043);
      color: var(--warning-contrast-color, #fff);
      @apply --error-toast;
    }

    tutorial-toast {
      position: absolute;
    }

    .add-fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
    }

    .empty-screen {
      @apply --layout-vertical;
      @apply --layout-center;
      @apply --host-rules-editor-empty-screen;
    }

    .caption {
      @apply --arc-font-caption;
    }

    p.explanation code {
      display: block;
    }

    host-rules-editor-item {
      padding: 0 16px;
    }

    *[hidden] {
      display: none !important;
    }

    host-rules-tester {
      margin: 8px 16px;
      padding: 8px;
      background-color: var(--host-rules-editor-tester-background-color, #FFE0B2);
      @apply --host-rules-editor-tester-background;
    }

    tutorial-toast {
      position: absolute;
      @apply --host-rules-editor-tutorial-toast;
    }
    </style>
    <div class="header">
      <h2>Hosts rules mapping</h2>
      <div class="header-actions">
        <paper-button hidden$="[[dataUnavailable]]" raised on-tap="toggleRulesTester">Test rules</paper-button>
        <paper-menu-button dynamic-align id="mainMenu">
          <paper-icon-button icon="arc:more-vert" class="dropdown-trigger"></paper-icon-button>
          <paper-listbox class="dropdown-content" id="mainMenuOptions">
            <paper-item on-tap="_onExportAll" data-action="export-all">
              Export all
            </paper-item>
            <paper-item on-tap="_onLearnMore" data-action="learn-more">
              Learn more abour host rules
            </paper-item>
          </paper-listbox>
        </paper-menu-button>
      </div>
    </div>
    <template is="dom-if" if="[[loading]]">
      <paper-progress indeterminate></paper-progress>
    </template>
    <iron-collapse opened="[[rulesTesterOpened]]">
      <host-rules-tester rules="[[items]]"></host-rules-tester>
    </iron-collapse>
    <template is="dom-if" if="[[dataUnavailable]]">
      <div class="empty-screen">
        <h3 class="empty-title">No mappings available</h3>
        <p class="empty-message">
          Create a host rule to redirect traffic from one host to another
        </p>
        <h3>Examples</h3>
        <p class="caption">Any call to https://*.domain.com/api redirect to http://127.0.0.1/</p>
        <code>From "https://*.domain.com/api" To "http://127.0.0.1/"</code>
        <p class="explanation">This transforms <code>https://my.domain.com/api/endpoint?param=value</code> to <code>http://127.0.0.1/endpoint?param=value</code> when creating a conneciton</p>
        <paper-button raised on-tap="_onLearnMore">More examples</paper-button>
      </div>
    </template>
    <template is="dom-if" if="[[!dataUnavailable]]">
      <template is="dom-repeat" items="{{items}}">
        <host-rules-editor-item narrow="[[narrow]]" host-from="{{item.from}}" host-to="{{item.to}}" enabled="{{item.enabled}}" comment="{{item.comment}}" on-remove-rule="_deleteRule"></host-rules-editor-item>
      </template>
    </template>
    <tutorial-toast opened="[[dataUnavailable]]">
      Add a rule to redirect traffic without editing your hosts file.
    </tutorial-toast>
    <paper-toast id="noModel" class="error-toast" text="Model not found. Please, report an issue."></paper-toast>
    <paper-toast id="noExport" class="error-toast" text="Export module not found. Please, report an issue."></paper-toast>
    <paper-toast id="deleteError" class="error-toast" text="Unable to delete rule. Please, report an issue."></paper-toast>
    <paper-toast id="updateError" class="error-toast" text="Unable to update rule. Please, report an issue."></paper-toast>
    <paper-dialog id="dataClearDialog" on-iron-overlay-closed="_onClearDialogResult">
      <h2>Danger zone</h2>
      <p>This will remove all stored rules. Without option to restore it.</p>
      <p>Maybe you should create a backup first?</p>
      <div class="buttons">
        <paper-button dialog-dismiss autofocus>Cancel</paper-button>
        <paper-button dialog-confirm class="action-button">Destroy</paper-button>
      </div>
    </paper-dialog>
    <paper-fab icon="arc:add" class="add-fab" on-tap="appendRule"></paper-fab>
    <uuid-generator id="uuid"></uuid-generator>
  </template>
  <script>
  Polymer({
    is: 'host-rules-editor',

    behaviors: [ArcBehaviors.OpenablePanelBehavior],

    properties: {
      // List of saved items restored from the datastore.
      items: {
        type: Array,
        observer: '_itemsChanged'
      },
      // Computed value, true if `items` is set.
      hasItems: {
        type: Boolean,
        readOnly: true,
        value: false
      },
      // True when loading data from the datastore.
      loading: {
        type: Boolean,
        readOnly: true,
        notify: true
      },
      /**
       * A computed flag that determines that the query to the databastore
       * has been performed and empty result was returned.
       * This can be true only if not in search.
       */
      dataUnavailable: {
        type: Boolean,
        computed: '_computeDataUnavailable(hasItems, loading)'
      },
      /**
       * If set it renders "narrow" view fow small screens
       */
      narrow: Boolean,
      /**
       * If true the rules tester is visible.
       */
      rulesTesterOpened: Boolean
    },

    observers: [
      '_processOnShow(_isOpened)',
      '_modelChanged(items.*)'
    ],

    attached: function() {
      this.listen(window, 'host-rules-changed', '_ruleUpdated');
      this.listen(window, 'host-rules-deleted', '_ruleDeleted');
    },

    detached: function() {
      this.unlisten(window, 'host-rules-changed', '_ruleUpdated');
      this.unlisten(window, 'host-rules-deleted', '_ruleDeleted');
    },

    // Queries the datastore for a data if data are not set already.
    _processOnShow: function(opened) {
      if (!opened || this.items) {
        return;
      }
      Polymer.RenderStatus.afterNextRender(this, function() {
        this.refresh();
      });
    },
    /**
     * Refreshes the list of rules from the model.
     * This element is designed to work with `arc-models/host-rules-model`
     * element but can work with any model that handles `host-rules-list`
     * custom event.
     *
     * Calling this function will replace current `items` value with the one
     * received from the model.
     */
    refresh: function() {
      if (this.loading) {
        return;
      }
      this._setLoading(true);
      var ev = this.fire('host-rules-list', {}, {
        cancelable: true
      });
      if (!ev.defaultPrevented) {
        this._setLoading(false);
        this.$.noModel.opened = true;
        return Promise.reject(new Error('Model not found'));
      }

      return ev.detail.result
      .then(rules => {
        this._setLoading(false);
        this.items = rules;
      });
    },

    // Computes value for the `dataUnavailable` proeprty
    _computeDataUnavailable: function(hasItems, loading) {
      return !loading && !hasItems;
    },

    // Computes and sets value for `hasItems` property
    _itemsChanged: function(value) {
      if (value && value.length) {
        if (!this.hasItems) {
          this._setHasItems(true);
        }
      } else {
        if (this.hasItems) {
          this._setHasItems(false);
        }
      }
    },
    // Menu item handler to export all data to a file
    _onExportAll: function() {
      this.$.mainMenu.opened = false;
      Polymer.RenderStatus.afterNextRender(this, function() {
        this.$.mainMenuOptions.selected = -1;
      });
      var ev = this.fire('export-user-data', {
        type: 'host-rules',
        destination: 'file',
        file: 'arc-host-rules.json'
      }, {
        cancelable: true,
        composed: true
      });
      if (!ev.defaultPrevented) {
        this.$.noExport.opened = true;
        return;
      }
    },
    /**
     * Appends empty rule to the rules list.
     */
    appendRule: function() {
      var rule = {
        from: '',
        to: '',
        enabled: true,
        comment: ''
      };
      if (!this.items || !this.items.length) {
        this.set('items', [rule]);
      } else {
        this.push('items', rule);
      }
    },

    _deleteRule: function(e) {
      var item = e.model.get('item');
      if (!item._id) {
        this.splice('items', e.model.get('index'), 1);
        return;
      }
      var ev = this.fire('host-rules-deleted', {
        id: item._id,
        rev: item._rev
      }, {
        cancelable: true
      });
      if (!ev.defaultPrevented) {
        this.$.noModel.opened = true;
        return Promise.reject(new Error('Model not found'));
      }
      return ev.detail.result
      .catch(() => {
        this.$.deleteError.opened = true;
      });
    },

    _modelChanged: function(record) {
      this._itemsChanged(record.base);
      if (record.path === 'items' || record.path === 'items.length' ||
        record.path === 'items.splices') {
        return;
      }
      if (record.path.indexOf('._rev') !== -1) {
        return;
      }
      var changePathItem = record.path.substr(0, record.path.lastIndexOf('.'));
      if (changePathItem === 'items') {
        changePathItem = record.path;
      }
      this.debounce('host-rules-changed-notifier', function() {
        let item = this.get(changePathItem);
        if (!item.from || !item.to) {
          return;
        }
        let newItem = false;
        if (!item._id) {
          item._id = this.$.uuid.generate();
          newItem = true;
        }
        let ev = this.fire('host-rules-changed', {
          rule: item
        }, {
          cancelable: true
        });
        ev.detail.result.then(item => {
          this.set(changePathItem + '._rev', item._rev);
        })
        .catch(cause => {
          console.eror(cause);
          this.$.updateError.opened = true;
        });
      }, 250);
    },
    /**
     * Updates a rule from the `host-rules-changed` custom event.
     * The event should contain `rule` property on the event's detail object
     * containing the rule object.
     */
    _ruleUpdated: function(e) {
      if (e.cancelable || e.target === this) {
        return;
      }
      var updatedValue = e.detail.rule;
      if (!this.items) {
        this.set('items', [updatedValue]);
        return;
      }
      var index = this.items.findIndex(item => item._id === updatedValue._id);
      if (index === -1) {
        this.push('items', updatedValue);
      } else {
        this.set(['items', index], updatedValue);
      }
    },
    /**
     * Deletes the rule from the `host-rules-deleted` custom event.
     * The event should contain `rule` property on the event's detail object
     * containing the rule object.
     */
    _ruleDeleted: function(e) {
      if (e.cancelable || e.target === this) {
        return;
      }
      if (!this.items || !this.items.length) {
        return;
      }
      var id = e.detail.id;
      var index = this.items.findIndex(item => item._id === id);
      if (index === -1) {
        return;
      }
      this.splice('items', index, 1);
    },
    /**
     * Toggles the rule tester view.
     * Use `rulesTesterOpened` property to control the view instead of calling
     * this function.
     */
    toggleRulesTester: function() {
      this.rulesTesterOpened = !this.rulesTesterOpened;
    },

    _onLearnMore: function() {
      var url = 'https://github.com/advanced-rest-client/arc-electron/wiki/Host-rules';
      window.open(url);
    }

    /**
     * Dispatched when value of a rule chnages.
     *
     * Note that the rule maight not be yet saved when this event is fired.
     *
     * The rule object contains all data received when dispatched `host-rules-list`
     * event with altered data. If the model added other properties that can identify
     * specific rule then it will be also included in `rule` object.
     *
     * @event host-rules-changed
     * @param {Object} rule Rule definition
     */

    /**
     * Dispatched when the user requested to delete rule entry.
     *
     * Note that the rule maight not be yet saved when this event is fired.
     * The model should check if the rule can be identified as a datastore
     * object.
     *
     * The rule object contains all data received when dispatched `host-rules-list`
     * event with altered data. If the model added other properties that can identify
     * specific rule then it will be also included in `rule` object.
     *
     * This event is cancelable
     *
     * @event host-rules-deleted
     * @param {Object} rule Rule definition
     */

    /**
     * Fired when the element request the list of available rules.
     *
     * It expect the event to be canceled by event handler and `result`
     * property to be set on the detail object which is a `Promise` resolved
     * to list of results.
     *
     * @event host-rules-list
     */
  });
  </script>
</dom-module>
